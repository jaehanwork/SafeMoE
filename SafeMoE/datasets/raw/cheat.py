import random
import json

from datasets import load_dataset, concatenate_datasets
from SafeMoE.datasets.base import RawDataset, RawSample


__all__ = ['CHEATTrain5kDataset']


class CHEATTrain5kDataset(RawDataset):
    NAME: str = 'CHEAT/train_5k'

    def __init__(self, path: str | None = None) -> None:
        # Load ieee-init.jsonl
        init_data = []
        with open('/root/SafeMoE/SafeMoE/datasets/raw/raw_data/ieee-init.jsonl', 'r') as f:
            for line in f:
                sample = json.loads(line.strip())
                sample['label'] = '0'
                init_data.append(sample)
        
        # Load ieee-chatgpt-polish.jsonl
        chatgpt_data = []
        with open('/root/SafeMoE/SafeMoE/datasets/raw/raw_data/ieee-chatgpt-polish.jsonl', 'r') as f:
            for line in f:
                sample = json.loads(line.strip())
                sample['label'] = '1'
                chatgpt_data.append(sample)
        
        # Merge the datasets
        self.data = init_data[:2500] + chatgpt_data[:2500]
        
        # Shuffle the combined dataset
        random.seed(42)
        random.shuffle(self.data)

        print('=============================')
        print(f'{self.NAME} {len(self.data)}')
        print('=============================')

    def __getitem__(self, index: int) -> RawSample:
        data = self.data[index]
        abstract = data['abstract']
        label = data['label']
        return RawSample(
            system_prompt='You are a helpful assistant for detecting AI-generated text.',
            input=f"Following text is an abstract of a paper, and you need to decide whether it is generated by language model. If the text is generated by language model, you should output 1; otherwise, you should output 0.\nAbstract: {abstract}",
            answer=f'Answer: {label}',
        )

    def __len__(self) -> int:
        return len(self.data)